<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>츼lbum de Recuerdos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root { --main-color: #2ecc71; }
body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; text-align:center; }
header { background:var(--main-color); color:white; padding:1.2rem; font-size:1.6rem; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
.container { max-width:1000px; margin:2rem auto; padding:0 1rem; }
.add-button { background:var(--main-color); color:white; font-weight:600; padding:1rem 2rem; border-radius:10px; cursor:pointer; transition:0.3s; margin-bottom:2rem; border:none; font-size:1rem; }
.add-button:hover { background:#27ae60; }
.gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem; }
.gallery-item { background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; transition: transform 0.2s; }
.gallery-item:hover { transform:scale(1.03); }
.gallery-item img, .gallery-item video { width:100%; height:220px; object-fit:cover; display:block; }
.loading { display:none; margin-top:1rem; color:var(--main-color); font-weight:bold; }
.footer { margin:2rem 0 4rem; color:#666; }
</style>
</head>
<body>
<header>游닞 츼lbum de Recuerdos</header>

<div class="container">
  <button id="addButton" class="add-button">Agregar Recuerdo</button>
  <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
  <div class="loading" id="loading">Cargando...</div>
  <div class="gallery" id="gallery"></div>
  <div class="footer" id="footerInfo"></div>
</div>

<footer style="text-align:center;padding:1rem 0 3rem;color:#888;">Hecho con 游눜</footer>

<script>
/* ======== CONFIG ======== */
// URL del Web App de Google Apps Script (reemplaza por tu URL /exec)
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6uoAGx_Xq33chhSfJJ4BiwH8ED5JTlGUi2oJe3gkLIu_v-T2UC_l6YAvXQXBtWbJbEA/exec';

// Carpeta/prefix en Cloudinary que quieres listar
const FOLDER = 'moments';

// Qu칠 tipo: 'all' | 'image' | 'video'
const RESOURCE_TYPE = 'all';

// Paginaci칩n para render (cliente)
const PAGE_SIZE = 20;

/* ======== ESTADO ======== */
let resources = [];
let index = 0;
const gallery = document.getElementById('gallery');
const loading = document.getElementById('loading');
const footerInfo = document.getElementById('footerInfo');

function renderItem(r) {
  const div = document.createElement('div');
  div.className = 'gallery-item';
  // usar secure_url preferiblemente
  const url = r.secure_url || r.url || '';
  if (!url) return;
  if ((r.resource_type && r.resource_type.toLowerCase() === 'video') || url.match(/\.(mp4|mov|webm)$/i)) {
    const v = document.createElement('video');
    v.src = url;
    v.controls = true;
    v.preload = 'none';
    v.loading = 'lazy';
    v.style.height = '220px';
    div.appendChild(v);
  } else {
    const img = document.createElement('img');
    img.src = url;
    img.alt = r.public_id || 'recuerdo';
    img.loading = 'lazy';
    div.appendChild(img);
  }
  gallery.appendChild(div);
}

function renderNextPage() {
  const next = resources.slice(index, index + PAGE_SIZE);
  next.forEach(renderItem);
  index += PAGE_SIZE;
}

/* Scroll infinito simple */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 150) {
    if (index < resources.length) renderNextPage();
  }
});

/* ======== FETCH al proxy ======== */
async function fetchResources() {
  loading.style.display = 'block';
  gallery.innerHTML = '';
  footerInfo.textContent = '';

  // URL con par치metros
  const url = new URL(APPS_SCRIPT_URL);
  url.searchParams.set('folder', FOLDER);
  url.searchParams.set('resource_type', RESOURCE_TYPE);
  // Intenta fetch est치ndar
  try {
    const res = await fetch(url.toString(), { method: 'GET', credentials: 'omit' });
    if (!res.ok) {
      // si status 4xx/5xx, intentar fallback JSONP
      throw new Error('Fetch fallo con status ' + res.status);
    }
    const js = await res.json();
    if (!js.ok) {
      throw new Error('Proxy error: ' + JSON.stringify(js.error || js));
    }
    resources = js.resources || [];
    footerInfo.textContent = `Recursos: ${resources.length}`;
    index = 0;
    renderNextPage();
  } catch (err) {
    console.warn('fetch error, intentando JSONP fallback', err);
    // Fallback JSONP: insertar <script> con callback
    try {
      await fetchViaJSONP(url);
    } catch (e2) {
      loading.style.display = 'none';
      gallery.innerHTML = '<p>Error cargando recursos (revisa consola)</p>';
      console.error('JSONP fallback error', e2);
    }
  } finally {
    loading.style.display = 'none';
  }
}

/* JSONP fallback:
   Si por alguna raz칩n CORS bloquea el fetch, el proxy acepta ?callback=miFn y responde JavaScript.
   Esta funci칩n inyecta un <script> y espera la llamada.
*/
function fetchViaJSONP(baseUrl) {
  return new Promise((resolve, reject) => {
    const cbName = 'cloudProxyCB_' + Math.random().toString(36).substr(2,8);
    window[cbName] = function(data) {
      try {
        if (!data || !data.ok) {
          reject(new Error('JSONP error: ' + JSON.stringify(data)));
          return;
        }
        resources = data.resources || [];
        footerInfo.textContent = `Recursos: ${resources.length} (via JSONP)`;
        index = 0;
        renderNextPage();
        resolve();
      } finally {
        // cleanup
        try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
        script.remove();
      }
    };

    const script = document.createElement('script');
    const u = new URL(baseUrl.toString());
    u.searchParams.set('callback', cbName);
    script.src = u.toString();
    script.onerror = function(ev) {
      try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
      script.remove();
      reject(new Error('JSONP script load error'));
    };
    document.body.appendChild(script);
    // si no resuelve en 10s, rechaza
    setTimeout(() => {
      if (window[cbName]) {
        try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
        script.remove();
      }
      reject(new Error('JSONP timeout'));
    }, 10000);
  });
}

/* ======== UPLOAD (opcional) ========
   Si quieres mantener la funcionalidad de upload desde GH Pages hacia Cloudinary,
   necesitas un upload preset "unsigned" en Cloudinary o subir desde tu servidor.
   Aqu칤 dejo simple l칩gica de upload usando un upload_preset unsigned (ya ten칤as en tu c칩digo).
*/
const CLOUD_NAME = 'dvyf7rti4'; // si usas tu propia cuenta, mantenla privada si no usas unsigned
const UPLOAD_PRESET = 'evory-moments'; // unsigned preset si quieres permitir upload directo desde cliente
const fileInput = document.getElementById('fileInput');
const addButton = document.getElementById('addButton');

addButton.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  loading.style.display = 'block';
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fd.append('folder', FOLDER);
  try {
    // upload directo a Cloudinary (unsigned preset)
    const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
      method: 'POST',
      body: fd
    });
    const data = await resp.json();
    if (data.secure_url) {
      // a침adir al inicio y re-render
      resources.unshift({
        secure_url: data.secure_url,
        resource_type: data.resource_type || 'image',
        public_id: data.public_id,
        created_at: data.created_at
      });
      // re-render simplificado: limpiar y mostrar primeras PAGE_SIZE
      gallery.innerHTML = '';
      index = 0;
      renderNextPage();
      footerInfo.textContent = `Recursos: ${resources.length} (incluye upload reciente)`;
    } else {
      alert('Error al subir: ' + JSON.stringify(data));
    }
  } catch (err) {
    alert('Error upload: ' + err.message);
  } finally {
    loading.style.display = 'none';
    fileInput.value = '';
  }
});

/* ======== Inicial ======== */
fetchResources();
</script>
</body>
</html>
