<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>√Ålbum de Recuerdos</title>
<link rel="icon" type="image/png" href="https://i.postimg.cc/hvt9n3XN/icon-album.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Corinthia:wght@400;700&display=swap" rel="stylesheet">

<style>
:root {
  --main-color: #2ecc71;
  --bg-color: #ffffff;
  --card-bg: rgba(250, 250, 250, 0.95);
  --text-color: #333333;
  --shadow-color: rgba(0,0,0,0.2);
}

body { 
  font-family: "Corinthia", cursive;
  margin:0; 
  padding:0; 
  background: var(--bg-color); 
  color: var(--text-color); 
  text-align:center; 
}

body.preview-open { overflow: hidden; }

header { 
  background: var(--main-color); 
  color:white; 
  padding:1.2rem; 
  font-size:1.6rem; 
  font-weight:600; 
  box-shadow:0 2px 6px rgba(0,0,0,0.2); 
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  z-index: 1000;
}

.container { 
  max-width:1000px; 
  margin:5rem auto 1rem; 
  padding:0 0; 
}

.gallery { 
  display:grid; 
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); 
  gap:0.5rem; 
}

.gallery-item { 
  background: var(--card-bg);
  overflow: hidden;
  box-shadow: 0 4px 12px var(--shadow-color);
  position: relative;
  transition: transform 0.3s, box-shadow 0.3s;
  aspect-ratio: 1/1; 
}

.gallery-item:hover { 
  transform: translateY(-3px) scale(1.03); 
  box-shadow: 0 8px 20px var(--shadow-color);
}

.gallery-item img, .gallery-item video { 
  width: 100%; 
  height: 100%; 
  object-fit: cover; 
  opacity: 0; 
  transition: opacity .3s; 
  image-rendering: auto;
}

.play-icon {
  position: absolute;
  top:50%;
  left:50%;
  transform: translate(-50%, -50%);
  width:40px;
  height:40px;
  background: rgba(255,255,255,0.6);
  clip-path: polygon(25% 20%, 25% 80%, 80% 50%);
  pointer-events:none;
  z-index:2;
}

.loading { 
  display:none; 
  margin-top:1rem; 
  color:var(--main-color); 
  font-weight:bold; 
}

.footer { 
  margin:4rem 0 1rem; 
  color:#666; 
  font-size:0.9rem; 
}

@media (max-width: 600px) {
  .gallery.mobile-grid {
    grid-template-columns: repeat(5, 1fr) !important;
    gap: 2px;
  }
  .gallery-item { width: 100%; aspect-ratio: 1/1; }
  .gallery.mobile-grid .gallery-item img,
  .gallery.mobile-grid .gallery-item video { height: 100% !important; }
}

#addButton {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--main-color);
  color: white;
  font-weight: 600;
  padding: 0.8rem 1.2rem; 
  border-radius: 50px;
  border: none;
  font-size: 1rem;
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 9999;
  width: 70%;
}

#addButton:hover {
  background: #27ae60;
  transform: translateX(-50%) scale(1.05);
}

#previewOverlay {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.95);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 99999;
}

#previewContent {
  max-width: 90%;
  max-height: 85%;
  border-radius: 20px;
  overflow: hidden;
  position: relative;
}

#previewContent img,
#previewContent video {
  width: 100%;
  height: auto;
  border-radius: 20px;
}

#closePreview {
  position:absolute;
  top:20px;
  right:20px;
  font-size:30px;
  color:white;
  cursor:pointer;
}

#prevBtn, #nextBtn {
  position:absolute;
  top:50%;
  transform: translateY(-50%);
  font-size:50px;
  color:white;
  cursor:pointer;
  user-select: none;
  text-shadow: 0 0 10px black;
}

#prevBtn { left:10px; }
#nextBtn { right:10px; }

.progress-bar-container {
  width: 70%;
  height: 8px;
  background: #eee;
  border-radius: 5px;
  margin: 0.5rem auto;
  overflow: hidden;
  display: none;
}

.progress-bar { height: 100%; width: 0%; background: var(--main-color); transition: width 0.2s; }
</style>
</head>
<body>

<header>üì∏ Mis XV - Camila AA</header>

<div class="container">
  <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display:none;">
  <div class="loading" id="loading">Cargando...</div>
  <div class="progress-bar-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="gallery mobile-grid" id="gallery"></div>
  <div class="footer" id="footerInfo"></div>
</div>

<button id="addButton">Agregar Recuerdo</button>

<div id="previewOverlay">
  <span id="closePreview">‚úñ</span>
  <div id="previewContent"></div>
  <span id="prevBtn">‚ùÆ</span>
  <span id="nextBtn">‚ùØ</span>
</div>

<footer style="text-align:center;color:#888;">Hecho con üíö</footer>

<script>
const WORKER_URL = 'https://lively-bush-fa83.jeastinls02.workers.dev/';
const FOLDER = 'moments';
const RESOURCE_TYPE = 'all';
const PAGE_SIZE = 50;
const MAX_FILES = 10;
const CLOUD_NAME = 'dvyf7rti4';
const UPLOAD_PRESET = 'evory-moments';

let resources = [];
let index = 0;
let currentPreviewIndex = 0;

const gallery = document.getElementById('gallery');
const loading = document.getElementById('loading');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const footerInfo = document.getElementById('footerInfo');
const fileInput = document.getElementById('fileInput');
const addButton = document.getElementById('addButton');

const previewOverlay = document.getElementById("previewOverlay");
const previewContent = document.getElementById("previewContent");
const closePreview = document.getElementById("closePreview");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

let previewCache = [];

const imgObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const el = entry.target;
      if (el.dataset.src) el.src = el.dataset.src;
      el.style.opacity = "1";
      imgObserver.unobserve(el);
    }
  });
});

function disableApp() { document.body.classList.add('preview-open'); addButton.disabled = true; }
function enableApp() { document.body.classList.remove('preview-open'); addButton.disabled = false; }

closePreview.onclick = () => {
  previewOverlay.style.display = "none";
  enableApp();
  const v = previewContent.querySelector("video");
  if(v) { v.pause(); v.src=""; }
  previewContent.innerHTML = "";
};

function openPreview(index) {
  disableApp();
  currentPreviewIndex = index;
  previewContent.innerHTML = "";

  const cachedNode = previewCache[index];
  if(!cachedNode) return;

  const node = cachedNode.cloneNode(true);
  node.style.width = "100%";
  node.style.height = "auto";
  if(node.tagName === "VIDEO") node.controls = true, node.autoplay = true;

  previewContent.appendChild(node);

  // Bot√≥n de descarga solo en preview, flotante y centrado
  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Descargar ‚¨á';
  downloadBtn.style.position = 'fixed';
  downloadBtn.style.bottom = '20px';
  downloadBtn.style.left = '50%';
  downloadBtn.style.transform = 'translateX(-50%)';
  downloadBtn.style.padding = '12px 20px';
  downloadBtn.style.fontSize = '1rem';
  downloadBtn.style.border = 'none';
  downloadBtn.style.borderRadius = '50px';
  downloadBtn.style.background = 'var(--main-color)';
  downloadBtn.style.color = 'white';
  downloadBtn.style.cursor = 'pointer';
  downloadBtn.style.zIndex = '10000';
  downloadBtn.style.width = '70%';

  downloadBtn.onclick = async () => {
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'Descargando... ‚è≥';
    const r = resources[index];
    const url = r.secure_url;
    const isVideo = (r.resource_type === 'video') || url.match(/\.(mp4|mov|webm)$/i);
    try {
      const blob = await fetch(url).then(res => res.blob());
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = r.public_id + (isVideo ? '.mp4' : '.jpg');
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    } catch(err) {
      console.error(err);
    }
    downloadBtn.textContent = '‚¨á Descargar';
    downloadBtn.disabled = false;
  };

  previewContent.appendChild(downloadBtn);
  previewOverlay.style.display = "flex";
}

function showPrev() { if(currentPreviewIndex > 0) openPreview(--currentPreviewIndex); }
function showNext() { if(currentPreviewIndex < resources.length -1) openPreview(++currentPreviewIndex); }
prevBtn.onclick = showPrev;
nextBtn.onclick = showNext;

document.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft') showPrev();
  if(e.key==='ArrowRight') showNext();
});

let touchStartX = null;
previewOverlay.addEventListener('touchstart', e=>{ touchStartX = e.changedTouches[0].screenX; });
previewOverlay.addEventListener('touchend', e=>{
  if(touchStartX === null) return;
  let deltaX = e.changedTouches[0].screenX - touchStartX;
  if(deltaX > 50) showPrev();
  else if(deltaX < -50) showNext();
  touchStartX = null;
});

function renderItem(r, idx) {
  const div = document.createElement('div');
  div.className = 'gallery-item';
  const url = r.secure_url || r.url || '';
  if (!url) return;

  const isVideo = (r.resource_type === 'video') || url.match(/\.(mp4|mov|webm)$/i);
  if(isVideo){
    const poster = `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/q_auto,f_auto,w_600,h_400,c_fill/${r.public_id}.jpg`;
    const img = document.createElement('img');
    img.dataset.src = poster;
    img.alt = r.public_id;
    img.style.cursor = "pointer";
    img.addEventListener('click', ()=>openPreview(idx));
    div.appendChild(img);

    const playIcon = document.createElement('div');
    playIcon.className = 'play-icon';
    div.appendChild(playIcon);

    const videoNode = document.createElement('video');
    videoNode.src = r.secure_url;
    videoNode.preload = "auto";
    videoNode.muted = true;
    previewCache[idx] = videoNode;
  } else {
    const img = new Image();
    img.src = url.replace('/upload/', '/upload/f_auto,q_auto,w_800/');
    img.alt = r.public_id;
    img.style.cursor = "pointer";
    img.addEventListener('click', ()=>openPreview(idx));
    previewCache[idx] = img;
    div.appendChild(img);
  }

  imgObserver.observe(div.querySelector("img"));
  gallery.appendChild(div);
}

function renderNextPage() {
  const next = resources.slice(index, index + PAGE_SIZE);
  next.forEach((r,i)=>renderItem(r, index+i));
  index += PAGE_SIZE;
}

window.addEventListener('scroll', () => {
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 150){
    if(index < resources.length) renderNextPage();
  }
});

async function fetchResources() {
  loading.style.display = 'block';
  gallery.innerHTML = '';
  footerInfo.textContent = '';

  const url = new URL(WORKER_URL);
  url.searchParams.set('folder', FOLDER);
  url.searchParams.set('resource_type', RESOURCE_TYPE);

  try {
    const res = await fetch(url.toString());
    const js = await res.json();
    resources = js.resources || [];
    footerInfo.textContent = `Recursos: ${resources.length}`;
    index = 0;
    renderNextPage();
  } catch(err) {
    gallery.innerHTML = '<p>Error cargando recursos.</p>';
  }
  loading.style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

addButton.onclick = () => fileInput.click();

fileInput.onchange = async (e)=>{
  let files = Array.from(e.target.files);
  if(files.length === 0) return;
  if(files.length > MAX_FILES){
    alert("Solo puedes seleccionar hasta: " + MAX_FILES +" archivos a la vez.");
    fileInput.value = "";
    return;
  }

  window.scrollTo({ top: 0, behavior: 'auto' });
  loading.style.display = 'block';
  progressContainer.style.display = 'block';
  progressBar.style.width = '0%';

  setTimeout(async ()=>{
    for(let i=0;i<files.length;i++){
      const fd = new FormData();
      fd.append('file', files[i]);
      fd.append('upload_preset', UPLOAD_PRESET);
      fd.append('folder', FOLDER);

      const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method:'POST', body:fd });
      const data = await resp.json();
      if(data.secure_url) resources.unshift({secure_url: data.secure_url, resource_type: data.resource_type, public_id: data.public_id});

      progressBar.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
    }

    gallery.innerHTML='';
    index=0;
    previewCache = [];
    renderNextPage();
    footerInfo.textContent = `Recursos: ${resources.length}`;

    loading.style.display = 'none';
    progressContainer.style.display = 'none';
    fileInput.value='';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 50);
};

fetchResources();
</script>
</body>
</html>
