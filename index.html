<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>√Ålbum de Recuerdos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root { --main-color: #2ecc71; }

body { 
  font-family: 'Poppins', sans-serif; 
  margin:0; 
  padding:0; 
  background:#f5f5f5; 
  color:#333; 
  text-align:center; 
}
header { 
  background:var(--main-color); 
  color:white; 
  padding:1.2rem; 
  font-size:1.6rem; 
  font-weight:600; 
  box-shadow:0 2px 6px rgba(0,0,0,0.2); 
}

.container { max-width:1000px; margin:2rem auto; padding:0 1rem; }

.gallery { 
  display:grid; 
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); 
  gap:1rem; 
}
.gallery-item { 
  background:white; 
  border-radius:10px; 
  overflow:hidden; 
  box-shadow:0 2px 6px rgba(0,0,0,0.1); 
  transition: transform 0.2s; 
}
.gallery-item:hover { transform:scale(1.03); }
.gallery-item img, .gallery-item video { 
  width:100%; 
  height:220px; 
  object-fit:cover; 
  opacity:0; 
  transition:opacity .3s; 
}

.loading { display:none; margin-top:1rem; color:var(--main-color); font-weight:bold; }
.footer { margin:2rem 0 4rem; color:#666; }

/* === 4 POR FILA EN MOBILE === */
@media (max-width: 600px) {
  .gallery.mobile-grid {
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 6px;
  }
  .gallery.mobile-grid .gallery-item img,
  .gallery.mobile-grid .gallery-item video {
    height: 100px !important;
  }
}

/* === BOT√ìN FLOTANTE CENTRADO ABAJO === */
#addButton {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--main-color);
  color: white;
  font-weight: 600;
  padding: 0.9rem 1.6rem;
  border-radius: 50px;
  border: none;
  font-size: 1rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  cursor: pointer;
  z-index: 9999;
}
#addButton:hover {
  background: #27ae60;
}

/* === PREVIEW (LIGHTBOX) === */
#previewOverlay {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 99999;
}

#previewWrapper {
  max-width: 95%;
  max-height: 90%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

#previewContent {
  max-width: 100%;
  max-height: 100%;
}

#previewContent img,
#previewContent video {
  width: 100%;
  height: auto;
  border-radius: 10px;
  display: block;
  max-height: 90vh;
}

#closePreview {
  position:absolute;
  top:14px;
  right:14px;
  font-size:28px;
  color:white;
  cursor:pointer;
  z-index: 100000;
  user-select: none;
}
</style>
</head>
<body>

<header>üì∏ √Ålbum de Recuerdos</header>

<div class="container">
  <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
  <div class="loading" id="loading">Cargando...</div>

  <div class="gallery mobile-grid" id="gallery"></div>

  <div class="footer" id="footerInfo"></div>
</div>

<!-- BOT√ìN CENTRADO -->
<button id="addButton">Agregar Recuerdo</button>

<!-- PREVIEW -->
<div id="previewOverlay" aria-hidden="true">
  <div id="previewWrapper" role="dialog" aria-modal="true">
    <span id="closePreview" aria-label="Cerrar">‚úñ</span>
    <div id="previewContent"></div>
  </div>
</div>

<footer style="text-align:center;padding:1rem 0 3rem;color:#888;">Hecho con üíö</footer>

<script>
/* ======== CONFIG ======== */
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwh9182ZGUHoCx49D-txEuQdtHe-QgBVsZOOhO7tIy8MRrZWGWPAc58lnPuUMylhhhKLg/exec';
const FOLDER = 'moments';
const RESOURCE_TYPE = 'all';
const PAGE_SIZE = 30;
const CLOUD_NAME = 'dvyf7rti4'; // tu cloud name

/* ======== ESTADO ======== */
let resources = [];
let index = 0;

const gallery = document.getElementById('gallery');
const loading = document.getElementById('loading');
const footerInfo = document.getElementById('footerInfo');
const addButton = document.getElementById('addButton');
const fileInput = document.getElementById('fileInput');

/* === OBSERVER PARA IM√ÅGENES (lazy) === */
const imgObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const el = entry.target;
      if (el.dataset.src) el.src = el.dataset.src;
      el.style.opacity = "1";
      imgObserver.unobserve(el);
    }
  });
}, { rootMargin: '200px 0px' }); // prefetch un poco antes de entrar

/* === PREVIEW LIGHTBOX Y CACHE PROGRESIVA === */
const previewOverlay = document.getElementById("previewOverlay");
const previewContent = document.getElementById("previewContent");
const closePreview = document.getElementById("closePreview");

closePreview.addEventListener('click', closePreviewFn);
previewOverlay.addEventListener('click', (e) => {
  if (e.target === previewOverlay) closePreviewFn();
});

function closePreviewFn() {
  // detener y limpiar video si existe
  const vid = previewContent.querySelector('video');
  if (vid) {
    try { vid.pause(); } catch(e) {}
    vid.removeAttribute('src');
    vid.load && vid.load();
  }
  previewContent.innerHTML = '';
  previewOverlay.style.display = 'none';
  previewOverlay.setAttribute('aria-hidden','true');
}

/**
 * openPreview: muestra IMAGEN o VIDEO *r√°pido*.
 * Para im√°genes: muestra INMEDIATAMENTE la miniatura (thumb) y luego carga en background la versi√≥n mayor (progressive swap).
 * Para videos: muestra el poster en el modal; NO descarga el archivo hasta que el usuario presione play.
 *
 * params:
 *   opts.thumb -> URL de miniatura ya cargada (r√°pida)
 *   opts.full  -> URL optimizada de mayor resoluci√≥n (para reemplazo en imagen)
 *   opts.type  -> "image"|"video"
 *   opts.videoPoster -> (videos) poster url
 *   opts.videoFull -> (videos) url real (no se asigna hasta play)
 */
function openPreview(opts = {}) {
  previewContent.innerHTML = '';
  previewOverlay.style.display = 'flex';
  previewOverlay.setAttribute('aria-hidden','false');

  if (opts.type === 'video') {
    // Show poster immediately (image inside modal) and create video element that will only set src on play
    const posterImg = document.createElement('img');
    posterImg.src = opts.videoPoster || opts.thumb || '';
    posterImg.alt = 'video poster';
    posterImg.style.maxHeight = '80vh';
    previewContent.appendChild(posterImg);

    // Create video element but without src to avoid download
    const v = document.createElement('video');
    v.controls = true;
    v.style.display = 'none';
    v.style.maxHeight = '80vh';
    v.playsInline = true;

    // When user presses play, set src and swap (or replace)
    v.addEventListener('play', function onFirstPlay() {
      if (!v.src) {
        v.src = opts.videoFull || opts.full || '';
        // after we set src, remove poster image and show the video
        v.style.display = 'block';
        if (posterImg && posterImg.parentNode) posterImg.remove();
      }
      v.removeEventListener('play', onFirstPlay);
    }, { once: true });

    // also allow user to click poster to show the video player and set src when they click poster
    posterImg.addEventListener('click', () => {
      if (!v.src) {
        v.src = opts.videoFull || opts.full || '';
        if (posterImg && posterImg.parentNode) posterImg.remove();
      }
      v.style.display = 'block';
      v.play().catch(()=>{}); // ignore play promise errors in some browsers
    });

    previewContent.appendChild(v);
    return;
  }

  // IMAGE: rapid progressive preview
  const thumb = document.createElement('img');
  thumb.src = opts.thumb || opts.full || '';
  thumb.alt = 'preview';
  previewContent.appendChild(thumb);

  // start loading high-res optimized image in background; when ready, swap
  if (opts.full && opts.full !== opts.thumb) {
    const hi = new Image();
    hi.decoding = 'async';
    hi.src = opts.full;
    hi.onload = () => {
      // replace thumb with hi-res smoothly
      try {
        thumb.src = hi.src;
      } catch (e) {
        // fallback: do nothing
      }
    };
  }
}

/* === RENDER === */
function renderItem(r) {
  const div = document.createElement('div');
  div.className = 'gallery-item';

  const url = r.secure_url || r.url || '';
  if (!url) return;

  const publicId = r.public_id || '';

  /* === VIDEO === */
  if ((r.resource_type === 'video') || url.match(/\.(mp4|mov|webm)$/i)) {

    // poster tiny for grid & preview initial (very low q)
    const posterThumb = `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/q_10,w_300/${publicId}.jpg`;
    // in-grid we use poster image (video tag will show poster)
    const v = document.createElement('video');
    v.controls = false;
    v.preload = 'none';
    v.dataset.full = url; // real video url
    v.poster = posterThumb;
    v.style.opacity = "1";
    v.loading = 'lazy';

    // clicking opens preview with poster first; video src will not be assigned until user interacts in modal
    v.addEventListener('click', () => {
      openPreview({
        type: 'video',
        videoPoster: posterThumb,
        videoFull: url
      });
    });

    // Show poster quickly ‚Äî set a tiny thumbnail as background by inserting an img behind the video for faster perceived speed
    // We'll append video directly; browser will render poster.
    div.appendChild(v);
  }

  /* === IMAGEN === */
  else {
    // thumb used in grid (fast) and preview immediate; fullPreview is progressive larger version
    const thumbOptimized = url.replace('/upload/', '/upload/f_auto,q_auto,w_600/');
    const fullPreview = url.replace('/upload/', '/upload/f_auto,q_auto,w_1200/');

    const img = document.createElement('img');
    img.dataset.src = thumbOptimized;   // lazy loading source
    img.dataset.thumb = thumbOptimized; // quick preview immediate
    img.dataset.full = fullPreview;     // hi-res progressive
    img.alt = r.public_id || 'recuerdo';
    img.style.cursor = "pointer";
    img.loading = 'lazy';
    img.addEventListener("click", (e) => {
      // use immediate thumb if already loaded, otherwise fallback to dataset.thumb
      const thumb = img.currentSrc || img.dataset.thumb || img.dataset.src || thumbOptimized;
      openPreview({ type: 'image', thumb: thumb, full: img.dataset.full });
    });

    imgObserver.observe(img);
    div.appendChild(img);
  }

  gallery.appendChild(div);
}

function renderNextPage() {
  const next = resources.slice(index, index + PAGE_SIZE);
  next.forEach(renderItem);
  index += PAGE_SIZE;
}

/* === SCROLL INFINITO === */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 150) {
    if (index < resources.length) renderNextPage();
  }
});

/* === FETCH PRINCIPAL === */
async function fetchResources() {
  loading.style.display = 'block';
  gallery.innerHTML = '';
  footerInfo.textContent = '';

  const url = new URL(APPS_SCRIPT_URL);
  url.searchParams.set('folder', FOLDER);
  url.searchParams.set('resource_type', RESOURCE_TYPE);

  try {
    const res = await fetch(url.toString(), { method: 'GET', credentials: 'omit' });
    if (!res.ok) throw new Error('Fetch fallo ' + res.status);
    const js = await res.json();

    resources = js.resources || [];
    footerInfo.textContent = `Recursos: ${resources.length}`;

    index = 0;
    renderNextPage();
  } catch (err) {
    console.error(err);
    gallery.innerHTML = '<p>Error cargando recursos.</p>';
  } finally {
    loading.style.display = 'none';
  }
}

/* === UPLOAD (sin cambios, bot√≥n centrado atado al input) === */
const UPLOAD_PRESET = 'evory-moments';

addButton.onclick = () => fileInput.click();

fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  loading.style.display = 'block';

  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fd.append('folder', FOLDER);

  try {
    const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method:'POST', body:fd });
    const data = await resp.json();

    if (data.secure_url) {
      resources.unshift({
        secure_url: data.secure_url,
        resource_type: data.resource_type,
        public_id: data.public_id
      });

      gallery.innerHTML = '';
      index = 0;
      renderNextPage();
      footerInfo.textContent = `Recursos: ${resources.length}`;
    } else {
      console.error('Upload error', data);
      alert('Error al subir archivo');
    }
  } catch (e) {
    console.error(e);
    alert('Error al subir archivo');
  } finally {
    loading.style.display = 'none';
    fileInput.value = '';
  }
};

/* === START === */
fetchResources();
</script>
</body>
</html>
