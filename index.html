<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>√Ålbum de Recuerdos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root { --main-color: #2ecc71; }

body { 
  font-family: 'Poppins', sans-serif; 
  margin:0; 
  padding:0; 
  background:#f5f5f5; 
  color:#333; 
  text-align:center; 
}
header { 
  background:var(--main-color); 
  color:white; 
  padding:1.2rem; 
  font-size:1.6rem; 
  font-weight:600; 
  box-shadow:0 2px 6px rgba(0,0,0,0.2); 
}

.container { max-width:1000px; margin:2rem auto; padding:0 1rem; }

.gallery { 
  display:grid; 
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); 
  gap:1rem; 
}
.gallery-item { 
  background:white; 
  border-radius:10px; 
  overflow:hidden; 
  box-shadow:0 2px 6px rgba(0,0,0,0.1); 
  transition: transform 0.2s; 
}
.gallery-item:hover { transform:scale(1.03); }
.gallery-item img, .gallery-item video { 
  width:100%; 
  height:220px; 
  object-fit:cover; 
  opacity:0; 
  transition:opacity .3s; 
}

.loading { display:none; margin-top:1rem; color:var(--main-color); font-weight:bold; }
.footer { margin:2rem 0 4rem; color:#666; }

/* === 4 POR FILA EN MOBILE === */
@media (max-width: 600px) {
  .gallery.mobile-grid {
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 6px;
  }
  .gallery.mobile-grid .gallery-item img,
  .gallery.mobile-grid .gallery-item video {
    height: 100px !important;
  }
}

/* === BOT√ìN CENTRADO ABAJO === */
#addButton {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--main-color);
  color: white;
  font-weight: 600;
  padding: 1rem 1.4rem;
  border-radius: 50px;
  border: none;
  font-size: 1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 9999;
}
#addButton:hover {
  background: #27ae60;
}

/* === PREVIEW (LIGHTBOX) === */
#previewOverlay {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 99999;
}

#previewContent {
  max-width: 90%;
  max-height: 85%;
}

#previewContent img,
#previewContent video {
  width: 100%;
  height: auto;
  border-radius: 10px;
}

#closePreview {
  position:absolute;
  top:20px;
  right:20px;
  font-size:30px;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<header>üì∏ √Ålbum de Recuerdos</header>

<div class="container">
  <!-- MULTI UPLOAD -->
  <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display:none;">

  <div class="loading" id="loading">Cargando...</div>

  <div class="gallery mobile-grid" id="gallery"></div>

  <div class="footer" id="footerInfo"></div>
</div>

<!-- BOT√ìN CENTRADO -->
<button id="addButton">Agregar Recuerdo</button>

<!-- PREVIEW -->
<div id="previewOverlay">
  <span id="closePreview">‚úñ</span>
  <div id="previewContent"></div>
</div>

<footer style="text-align:center;padding:1rem 0 3rem;color:#888;">Hecho con üíö</footer>

<script>
/* ======== CONFIG ======== */
const WORKER_URL = 'https://lively-bush-fa83.jeastinls02.workers.dev/'; // <-- Cambiado a tu Worker
const FOLDER = 'moments';
const RESOURCE_TYPE = 'all';
const PAGE_SIZE = 30;

/* ======== ESTADO ======== */
let resources = [];
let index = 0;

const gallery = document.getElementById('gallery');
const loading = document.getElementById('loading');
const footerInfo = document.getElementById('footerInfo');

/* === OBSERVER PARA IM√ÅGENES === */
const imgObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const el = entry.target;
      if (el.dataset.src) el.src = el.dataset.src;
      el.style.opacity = "1";
      imgObserver.unobserve(el);
    }
  });
});

/* === PREVIEW LIGHTBOX === */
const previewOverlay = document.getElementById("previewOverlay");
const previewContent = document.getElementById("previewContent");
const closePreview = document.getElementById("closePreview");

closePreview.onclick = () => { previewOverlay.style.display = "none"; };

function openPreview(url, type) {
  previewContent.innerHTML = "";

  if (type === "video") {
    const v = document.createElement("video");
    v.src = url;
    v.controls = true;
    v.autoplay = true;
    previewContent.appendChild(v);
  } else {
    const img = document.createElement("img");
    img.src = url;
    previewContent.appendChild(img);
  }

  previewOverlay.style.display = "flex";
}

/* === RENDER === */
function renderItem(r) {
  const div = document.createElement('div');
  div.className = 'gallery-item';

  const url = r.secure_url || r.url || '';
  if (!url) return;

  const cloudName = "dvyf7rti4";
  const publicId = r.public_id;

  /* === VIDEO === */
  if ((r.resource_type === 'video') || url.match(/\.(mp4|mov|webm)$/i)) {

    const poster = `https://res.cloudinary.com/${cloudName}/video/upload/q_10,w_300,h_200,c_fill/${publicId}.jpg`;

    const v = document.createElement('video');
    v.controls = false;
    v.preload = 'none';
    v.dataset.src = url;
    v.poster = poster;
    v.style.opacity = "1";

    v.addEventListener('click', () => openPreview(url, "video"));

    div.appendChild(v);
  }

  /* === IMAGEN === */
  else {
    const optimized = url.replace('/upload/', '/upload/f_auto,q_auto,w_600/');

    const img = document.createElement('img');
    img.dataset.src = optimized;
    img.alt = r.public_id;
    img.style.cursor = "pointer";

    img.addEventListener("click", () => openPreview(url, "image"));

    imgObserver.observe(img);
    div.appendChild(img);
  }

  gallery.appendChild(div);
}

function renderNextPage() {
  const next = resources.slice(index, index + PAGE_SIZE);
  next.forEach(renderItem);
  index += PAGE_SIZE;
}

window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 150) {
    if (index < resources.length) renderNextPage();
  }
});

/* === FETCH PRINCIPAL === */
async function fetchResources() {
  loading.style.display = 'block';
  gallery.innerHTML = '';
  footerInfo.textContent = '';

  const url = new URL(WORKER_URL);
  url.searchParams.set('folder', FOLDER);
  url.searchParams.set('resource_type', RESOURCE_TYPE);

  try {
    const res = await fetch(url.toString());
    const js = await res.json();

    resources = js.resources || [];
    footerInfo.textContent = `Recursos: ${resources.length}`;

    index = 0;
    renderNextPage();
  } catch (err) {
    gallery.innerHTML = '<p>Error cargando recursos.</p>';
  }

  loading.style.display = 'none';
}

/* === UPLOAD MULTIPLE === */
const CLOUD_NAME = 'dvyf7rti4';
const UPLOAD_PRESET = 'evory-moments';
const fileInput = document.getElementById('fileInput');
const addButton = document.getElementById('addButton');

addButton.onclick = () => fileInput.click();

fileInput.onchange = async (e) => {
  const files = Array.from(e.target.files);
  if (files.length === 0) return;

  loading.style.display = 'block';

  for (const file of files) {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder', FOLDER);

    const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { 
      method:'POST', 
      body:fd 
    });

    const data = await resp.json();

    if (data.secure_url) {
      resources.unshift({
        secure_url: data.secure_url,
        resource_type: data.resource_type,
        public_id: data.public_id
      });
    }
  }

  gallery.innerHTML = '';
  index = 0;
  renderNextPage();
  footerInfo.textContent = `Recursos: ${resources.length}`;

  loading.style.display = 'none';
  fileInput.value = '';
};

/* === START === */
fetchResources();
</script>
</body>
</html>
